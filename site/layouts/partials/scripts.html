<script>
    /* -------------------------------------------------------------------------- */
    /* 1. TOOLTIP LOGIC                                                           */
    /* -------------------------------------------------------------------------- */
    (function () {
        const headers = document.querySelectorAll('th[data-tooltip]');
        let tooltip = null;
        let hideTimeout = null;
        let currentHeader = null;

        headers.forEach(th => {
            th.addEventListener('mouseenter', (e) => {
                if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
                if (currentHeader === th && tooltip) return;
                if (tooltip && tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);

                currentHeader = th;
                tooltip = document.createElement('div');
                tooltip.className = 'custom-tooltip';
                tooltip.textContent = th.getAttribute('data-tooltip');
                document.body.appendChild(tooltip);

                const rect = th.getBoundingClientRect();
                tooltip.style.position = 'fixed';
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.top = (rect.top - 10) + 'px';
                tooltip.style.transform = 'translate(-50%, -100%)';

                // ADD THIS LINE HERE:
                setTimeout(() => tooltip.classList.add('show'), 10);
            });

            th.addEventListener('mouseleave', () => {
                hideTimeout = setTimeout(() => {
                    if (tooltip) {
                        tooltip.classList.remove('show');
                        setTimeout(() => {
                            if (tooltip && tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
                            tooltip = null;
                            currentHeader = null;
                        }, 200);
                    }
                }, 100);
            });
        });
    })();

    /* -------------------------------------------------------------------------- */
    /* 2. UNIFIED DROPDOWN LOGIC (Single & Multi)                                 */
    /* -------------------------------------------------------------------------- */
    const allSelectInstances = [];

    // Helper to Capitalize First Letter
    function capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    class CustomSelect {
        constructor(element, onChange, isMulti = false) {
            this.element = element;
            this.onChange = onChange;
            this.isMulti = isMulti;
            this.selected = new Set();
            this.display = element.querySelector('.custom-select-display');
            this.dropdown = element.querySelector('.custom-select-dropdown');
            this.closeTimeout = null;

            allSelectInstances.push(this);

            // Toggle logic
            this.display.addEventListener('click', (e) => { e.stopPropagation(); this.toggle(); });
            this.dropdown.addEventListener('click', (e) => { e.stopPropagation(); });

            // Mouse Leave Logic (Close on exit)
            this.element.addEventListener('mouseleave', () => {
                this.closeTimeout = setTimeout(() => { this.close(); }, 300);
            });
            this.element.addEventListener('mouseenter', () => {
                if (this.closeTimeout) { clearTimeout(this.closeTimeout); this.closeTimeout = null; }
            });

            // Close on Global Click
            document.addEventListener('click', () => { this.close(); });

            // NEW: Close on Global Scroll (Prevents floating dropdowns)
            window.addEventListener('scroll', () => { if (this.isOpen()) this.close(); }, true);

            this.createFooter();
        }

        createFooter() {
            const footerDiv = document.createElement('div');
            footerDiv.className = 'custom-select-footer';
            const clearLink = document.createElement('a');
            clearLink.className = 'custom-select-clear';
            clearLink.textContent = 'Clear';
            clearLink.href = '#';
            clearLink.addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                this.clear();
                this.onChange();
            });
            footerDiv.appendChild(clearLink);
            this.footerElement = footerDiv;
        }

        setOptions(options) {
            this.dropdown.innerHTML = '';
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'custom-select-option';

                const input = document.createElement('input');
                input.type = this.isMulti ? 'checkbox' : 'radio';
                input.name = 'group-' + this.element.id;
                input.value = opt;
                input.checked = this.selected.has(opt);
                input.id = 'opt-' + this.element.id + '-' + opt.replace(/\s+/g, '-');
                input.style.pointerEvents = 'none';

                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.textContent = capitalize(opt);
                label.style.pointerEvents = 'none';

                div.appendChild(input);
                div.appendChild(label);

                // Row Click Handler
                div.addEventListener('click', (e) => {
                    e.stopPropagation();

                    if (this.isMulti) {
                        if (this.selected.has(opt)) {
                            this.selected.delete(opt);
                            input.checked = false;
                        } else {
                            this.selected.add(opt);
                            input.checked = true;
                        }
                    } else {
                        this.selected.clear();
                        this.selected.add(opt);
                        this.updateDisplay();
                        this.onChange();
                        this.close();
                        this.dropdown.querySelectorAll('input').forEach(r => r.checked = r.value === opt);
                        return;
                    }

                    this.updateDisplay();
                    this.onChange();
                });

                this.dropdown.appendChild(div);
            });
            if (this.footerElement) this.dropdown.appendChild(this.footerElement);
        }

        updateDisplay() {
            this.display.innerHTML = '';
            if (this.selected.size === 0) {
                this.display.classList.add('empty');
            } else {
                this.display.classList.remove('empty');
                const selectedText = Array.from(this.selected).map(val => capitalize(val)).join(', ');
                const textSpan = document.createElement('span');
                textSpan.textContent = selectedText;
                textSpan.style.color = '#334155';
                this.display.appendChild(textSpan);
            }
        }

        toggle() {
            const isOpen = this.dropdown.classList.contains('open');
            allSelectInstances.forEach(ms => ms.close()); // Close others

            if (!isOpen) {
                // DYNAMIC POSITIONING FIX
                // 1. Get position of the trigger button
                const rect = this.display.getBoundingClientRect();

                // 2. Set Fixed positioning to break out of table overflow
                this.dropdown.style.position = 'fixed';
                this.dropdown.style.top = (rect.bottom + 4) + 'px'; // 4px gap
                this.dropdown.style.left = rect.left + 'px';
                this.dropdown.style.width = 'auto'; // Reset width
                this.dropdown.style.minWidth = Math.max(rect.width, 160) + 'px'; // At least as wide as trigger
                this.dropdown.style.zIndex = '99999'; // Float above everything

                this.dropdown.classList.add('open');
            }
        }

        isOpen() {
            return this.dropdown.classList.contains('open');
        }

        close() {
            this.dropdown.classList.remove('open');
        }

        clear() {
            this.selected.clear();
            this.dropdown.querySelectorAll('input').forEach(cb => cb.checked = false);
            this.updateDisplay();
        }
        getSelected() { return this.selected; }
        getValue() { return this.selected.size > 0 ? Array.from(this.selected)[0] : ''; }
    }

    /* -------------------------------------------------------------------------- */
    /* 3. CONTROLLER                                                              */
    /* -------------------------------------------------------------------------- */
    (function () {
        const table = document.getElementById('appsTable');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const clearBtn = document.getElementById('clearFiltersBtn');
        const exportBtn = document.getElementById('exportCSVBtn');

        // Initialize Filters
        const filters = {
            sso: new CustomSelect(document.getElementById('filterSSO'), applyFilters, false),
            scim: new CustomSelect(document.getElementById('filterSCIM'), applyFilters, false),
            mfa: new CustomSelect(document.getElementById('filterMFA'), applyFilters, false),
            verified: new CustomSelect(document.getElementById('filterVerified'), applyFilters, false),
            category: new CustomSelect(document.getElementById('filterCategory'), applyFilters, true),
            protocols: new CustomSelect(document.getElementById('filterSSOProtocols'), applyFilters, true),
            mfaTypes: new CustomSelect(document.getElementById('filterMFATypes'), applyFilters, true),
            compliance: new CustomSelect(document.getElementById('filterCompliance'), applyFilters, true)
        };

        const appInput = document.getElementById('filterApp');
        let sortColumn = null;
        let sortDirection = 'asc';

        function populateFilters() {
            const values = {
                sso: new Set(), scim: new Set(), mfa: new Set(), verified: new Set(),
                category: new Set(), protocols: new Set(), mfaTypes: new Set(), compliance: new Set()
            };

            rows.forEach(row => {
                const td = row.cells[0];

                values.sso.add(td.getAttribute('data-sso'));
                values.scim.add(td.getAttribute('data-scim'));
                values.mfa.add(td.getAttribute('data-mfa'));
                values.verified.add(td.getAttribute('data-verified'));
                values.category.add(td.getAttribute('data-category'));

                td.getAttribute('data-sso-protocols').split(',').forEach(x => x.trim() && values.protocols.add(x.trim()));
                td.getAttribute('data-mfa-types').split(',').forEach(x => x.trim() && values.mfaTypes.add(x.trim()));
                td.getAttribute('data-compliance').split(',').forEach(x => x.trim() && values.compliance.add(x.trim().toUpperCase()));
            });

            // Single Selects
            ['sso', 'scim', 'mfa', 'verified'].forEach(k => {
                const filterFunc = k === 'scim' ? (v => v) : (v => v && v !== 'none');
                filters[k].setOptions(Array.from(values[k]).filter(filterFunc).sort());
            });

            // Multi Selects
            ['category', 'protocols', 'mfaTypes', 'compliance'].forEach(k => {
                filters[k].setOptions(Array.from(values[k]).filter(v => v).sort());
            });
        }

        function applyFilters() {
            const appVal = appInput.value.toLowerCase();

            rows.forEach(row => {
                const td = row.cells[0];
                let show = true;

                if (appVal && !td.getAttribute('data-app').toLowerCase().includes(appVal)) show = false;

                if (filters.sso.getValue() && td.getAttribute('data-sso') !== filters.sso.getValue()) show = false;
                if (filters.scim.getValue() && td.getAttribute('data-scim') !== filters.scim.getValue()) show = false;
                if (filters.mfa.getValue() && td.getAttribute('data-mfa') !== filters.mfa.getValue()) show = false;
                if (filters.verified.getValue() && td.getAttribute('data-verified') !== filters.verified.getValue()) show = false;

                const selCats = filters.category.getSelected();
                if (selCats.size > 0 && !selCats.has(td.getAttribute('data-category'))) show = false;

                const selProtos = filters.protocols.getSelected();
                if (selProtos.size > 0 && !td.getAttribute('data-sso-protocols').split(',').some(x => selProtos.has(x.trim()))) show = false;

                const selTypes = filters.mfaTypes.getSelected();
                if (selTypes.size > 0 && !td.getAttribute('data-mfa-types').split(',').some(x => selTypes.has(x.trim()))) show = false;

                const selComp = filters.compliance.getSelected();
                if (selComp.size > 0 && !td.getAttribute('data-compliance').split(',').some(x => selComp.has(x.trim().toUpperCase()))) show = false;

                row.classList.toggle('hidden', !show);
            });
        }

        function sortTable(columnIndex) {
            const visibleRows = rows.filter(row => !row.classList.contains('hidden'));
            if (sortColumn === columnIndex) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            else { sortColumn = columnIndex; sortDirection = 'asc'; }

            visibleRows.sort((a, b) => {
                const valA = a.cells[columnIndex].innerText.trim();
                const valB = b.cells[columnIndex].innerText.trim();
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            visibleRows.forEach(row => tbody.appendChild(row));
            updateArrows(columnIndex);
        }

        function updateArrows(idx) {
            table.querySelectorAll('thead th .sort-arrows').forEach((arrow, i) => {
                if (i === idx) {
                    arrow.classList.add('active');
                    arrow.textContent = sortDirection === 'asc' ? '▲' : '▼';
                } else {
                    arrow.classList.remove('active');
                    arrow.textContent = '⇅';
                }
            });
        }

        function clearAll() {
            appInput.value = '';
            Object.values(filters).forEach(f => f.clear());
            applyFilters();
        }

        function exportCSV() {
            const visible = rows.filter(r => !r.classList.contains('hidden'));
            let csv = "App,Category,SSO,Protocols,SCIM,MFA,MFA Types,Compliance,Verified\n";
            visible.forEach(row => {
                const cols = Array.from(row.cells).map(c => '"' + c.innerText.trim().replace(/"/g, '""') + '"');
                csv += cols.join(',') + "\n";
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            link.download = "saas-data.csv";
            link.click();
        }

        table.querySelectorAll('thead th').forEach((th, i) => th.addEventListener('click', () => sortTable(i)));
        appInput.addEventListener('input', applyFilters);
        if (clearBtn) clearBtn.addEventListener('click', clearAll);
        if (exportBtn) exportBtn.addEventListener('click', exportCSV);

        populateFilters();
        applyFilters();
    })();
</script>